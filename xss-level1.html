<!DOCTYPE html>
<html>
<head>
  <title>XSS Level 1 – Basic Reflected XSS</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 30px;
      background-color: #f4f4f4;
    }
    h2 {
      color: #333;
    }
    input[type="text"] {
      padding: 5px;
      width: 300px;
    }
    input[type="submit"] {
      padding: 5px 10px;
      background: #333;
      color: white;
      border: none;
      cursor: pointer;
    }
    #output {
      background: #fff;
      padding: 10px;
      margin-top: 20px;
      border: 1px solid #ccc;
      white-space: pre-wrap;
    }
    code {
      background: #eee;
      padding: 2px 6px;
      border-radius: 4px;
      font-family: monospace;
    }
  </style>
</head>
<body>

<h2>XSS Level 1 – Reflected XSS Challenge</h2>

<form method="GET">
  Enter your payload: <input name="payload" autocomplete="off" type="text">
  <input type="submit" value="Test">
</form>

<div id="output"></div>

<script>
// Step 1: Ask for username once
if (!localStorage.getItem("vulnlab-username")) {
  const uname = prompt("Enter your name (for flag generation):");
  if (uname) {
    localStorage.setItem("vulnlab-username", uname.trim().toLowerCase());
  } else {
    alert("Username required!");
  }
}

// Step 2: Generate Unique Flag
async function generateFlag(levelName) {
  const user = localStorage.getItem("vulnlab-username") || "guest";
  const secret = "xss_secret_salt_level1";
  const str = user + "-" + levelName + "-" + secret;

  const encoder = new TextEncoder();
  const data = encoder.encode(str);
  const hash = await crypto.subtle.digest("SHA-256", data);
  const hashArray = Array.from(new Uint8Array(hash));
  const hex = hashArray.map(b => b.toString(16).padStart(2, "0")).join("");
  return "CTF{" + hex.slice(0, 10) + "}";
}

// Step 3: Process Payload
const input = new URLSearchParams(window.location.search).get("payload");
const outputDiv = document.getElementById("output");

if (input) {
  outputDiv.innerHTML = input;

  if (input === "<script>alert('xss')</script>") {
    localStorage.setItem("xss-level1", "complete");
    generateFlag("xss-level1").then(flag => {
      outputDiv.innerHTML += `<br><br><strong>✅ Challenge Completed!</strong><br>Your Flag: <code>${flag}</code>`;
    });
  }
}
</script>

</body>
</html>
