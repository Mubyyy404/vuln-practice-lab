<!DOCTYPE html>
<html>
<head>
  <title>XSS Level 1 – Reflected XSS</title>
  <style>
    body { font-family: Arial, sans-serif; padding: 20px; background: #f9f9f9; }
    input, button { padding: 5px; margin: 5px; }
    #output { margin-top: 20px; padding: 10px; background: #fff; border: 1px solid #ccc; }
    code { background: #eee; padding: 2px 6px; border-radius: 4px; }
  </style>
</head>
<body>

<h2>Reflected XSS Challenge – Level 1</h2>

<form method="GET">
  Enter XSS Payload: <input type="text" name="payload" autocomplete="off">
  <button type="submit">Submit</button>
</form>

<div id="output"></div>

<script>
// Ask for username once
if (!localStorage.getItem("vulnlab-username")) {
  const uname = prompt("Enter your name:");
  if (uname) {
    localStorage.setItem("vulnlab-username", uname.trim().toLowerCase());
  } else {
    alert("Name required to continue.");
  }
}

// Function to generate unique flag
async function generateFlag(levelName) {
  const user = localStorage.getItem("vulnlab-username") || "guest";
  const secret = "xss_secret_salt_level1";
  const str = user + "-" + levelName + "-" + secret;
  const encoder = new TextEncoder();
  const data = encoder.encode(str);
  const hash = await crypto.subtle.digest("SHA-256", data);
  const hashArray = Array.from(new Uint8Array(hash));
  const hex = hashArray.map(b => b.toString(16).padStart(2, "0")).join("");
  return "CTF{" + hex.slice(0, 10) + "}";
}

// Get payload and reflect it
const input = new URLSearchParams(location.search).get("payload");
if (input) {
  document.getElementById("output").innerHTML = input;
}

// This part will run only when the script is executed (real XSS)
window.addEventListener("DOMContentLoaded", async () => {
  if (window.location.search.includes("<script>alert('xss')</script>")) {
    // Simulate challenge success AFTER code is executed
    if (!localStorage.getItem("xss-level1")) {
      localStorage.setItem("xss-level1", "complete");
      const flag = await generateFlag("xss-level1");
      alert("✅ XSS Detected! Your Flag: " + flag);
    }
  }
});
</script>

</body>
</html>
